---
title: "National Wildlife Refuge Funding"
output:
  flexdashboard::flex_dashboard:
    css: custom.css
    social: menu
    df_print: paged
    navbar:
    - {title: "CCI", align: right, href: "https://defenders-cci.org", target: "_blank"}
    - {title: "", icon: "fa-question-circle fa-lg", align: right, href: "mailto:jmalcom@defenders.org?subject=ESA intrastate species"}
    - {title: "", icon: "fa-github fa-lg", align: right, href: "https://github.com/laceym14/NWRs_spending", target: "_blank"}
runtime: shiny
---

```{r setup, include = FALSE}
library(dplyr)
library(plotly)
library(rvest)
library(shiny)
library(tibble)

# Convert CSV to RDS
#dat <- read.csv("NWRS_refined.csv")
#saveRDS(dat, file = "NWRS_refined.rds")
#natmon <- read.csv("table_10.csv")
#saveRDS(natmon, file = "table_10.rds")
#hatcheries <- read.csv("table_7.csv")
#saveRDS(hatcheries, file = "table_7.rds")
#wilderness <- read.csv("table_8.csv")
#saveRDS(wilderness, file = "table_8.rds")


# Read in dataset

dat <- read.csv("NWRS_refined.csv")
nm <- read.csv("table_10.csv")
fh <- read.csv("table_7.csv")
wa <- read.csv("table_8.csv")



dat <- readRDS(file = "NWRS_refined.rds")
natmon <- readRDS(file = "table_10.rds")
hatcheries <- readRDS(file = "table_7.rds")
wilderness <- readRDS(file = "table_8.rds")


# Get number of NWRs in each state
nwrs_state <- aggregate(
  dat$nwr_name ~ dat$state_territory, 
  FUN = function(x) length(unique(x))
)


# Get total pub spending in each state
cost_state <- aggregate(
  dat$pub_fws_purchase_cost ~ dat$state_territory, 
  FUN = sum)

# Clean up column naming for both datasets
names(nwrs_state) <- c("state", "refuge_count")
names(cost_state) <- c("state", "pub_cost")

# Join datasets into one
state_data <- left_join(cost_state, nwrs_state, by = "state")

# Import state abbreviations (needed for map later)
st_abbrev <- read.csv("st_abb.csv")

# Join state abbreviations into state_data dataset
state_data <- left_join(state_data, st_abbrev, by = "state")

# Get total number of refuge acres in each state
acres <- aggregate(
  dat$total_acres ~ dat$state_territory, 
  FUN = sum)
names(acres) <- c("state", "total_acres")

# Join acres to state_data
state_data <- left_join(state_data, acres, by = "state")

# Add column to calculate dollars spent per acre in each state and round to two decimal places
state_data$dollar_acre <- format(round(state_data$pub_cost / state_data$total_acres, 2), nsmall = 2)

# Get number of fish hatchery in each state
hatchery_state <- aggregate(
  fh$unit_name ~ fh$state, 
  FUN = function(x) length(unique(x))
)

#get total acres of hatchery in each state
total_hatchery_acres <- aggregate(
  fh$total_acres ~ fh$state,
  FUN = sum
)
names (total_hatchery_acres) <- c("state", "hatchery_acres")



#get total num of wilderness areas in each state
wa_state <- aggregate(
  wa$wilderness_name ~ wa$state,
  FUN = function(x) length(unique(x))
)

#clean up name
names(wa_state) <- c("state", "wilderness_count")

#get total wilderness acres in each state
acres3 <- aggregate(
  wa$wilderness_acres ~ wa$state,
  FUN = sum)
names (acres3) <- c("state", "wild_acres")

#join datasets into one
wild_state_data <- left_join(wa_state, acres3, by = "state")

#join state abbreviations into wild_state_data
wild_state_data <- left_join(wild_state_data, st_abbrev, by = "state")

#get total acre in each national monument under the NWRS 




```

Refuge System
=======================================================================

Column {data-width=200, .tabset}
-----------------------------------------------------------------------

### Introduction

USFWS provides expenditures data reports each year in 59 pages of dense PDFs. We have taken the time to extract the data and make this information readily available. 


### Overall U.S. Numbers


<div style='padding:3px; margin-bottom: 12px; background-color:#FF8400; color:white; border-radius:2px; font-size: 1.2em'>
Total refuge land area
```{r pct_overall}
tags$p(
  style = "font-size:2em; font-weight:600; color:white",
  sum(state_data$pub_cost), "acres"
)
```
</div>
<!-- <br> -->

<div style='padding-left:5px; padding-right:50px;'>
\# Acres Aquired by other agencies (the US Department of Energy, etc.)
```{r n_intra}
tags$p(
  style = "font-size:1.7em; font-weight:700;",
  sum(state_data$pub_cost)
)
```

<hr>

Total spending FY 2019 
```{r n_list}
tags$p(
  style = "font-size:1.7em; font-weight:700;",
  "$", sum(state_data$pub_cost)
)
```
</div>

<br>


Column {data-width=800}
-----------------------------------------------------------------------

### Federal spending on National Wildlife Refuges <span style="font-size:small">(hover over states for info)</span>

```{r map, echo=FALSE}
state_data$hover <- with(state_data, paste0(
  "<span style='font-size:larger;font-weight:bold'>", state, 
  ": $", pub_cost, "</span><br>", 
  "<b>Total amount spent per acre of refuge land: $</b> ", dollar_acre
))

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
  
renderPlotly({
  plot_geo(state_data, locationmode = 'USA-states', hoverlabel = "none") %>%
    add_trace(
      z = ~pub_cost, 
      text = ~hover,
      locations = ~state_abb,
      color = ~pub_cost, 
      colors = 'YlOrRd'
    ) %>%
    colorbar(title = "Amount Spent") %>%
    layout(geo = g)
})
```





Hatcheries
=======================================================================

Column {data-width=200}
-----------------------------------------------------------------------

### Introduction

Point to Table 7. Cleaned rows to not include sites that aren't true fish hatchery.

### Overall U.S. Numbers



<div style='padding:3px; margin-bottom: 12px; background-color:#FF8400; color:white; border-radius:2px; font-size: 1.2em'>
Total hatchery land area
```{r pct_overall2}
tags$p(
  style = "font-size:2em; font-weight:600; color:white",
  sum(state_data$pub_cost), "acres"
)
```
</div>
<!-- <br> -->

<div style='padding-left:5px; padding-right:50px;'>
\# Acres Aquired by other agencies (the US Department of Energy, etc.)
```{r n_intra2}
tags$p(
  style = "font-size:1.7em; font-weight:700;",
  sum(state_data$pub_cost)
)
```

<hr>

Total spending FY 2019 
```{r n_list2}
tags$p(
  style = "font-size:1.7em; font-weight:700;",
  "$", sum(state_data$pub_cost)
)
```
</div>

<br>


Column {data-width=800}
-----------------------------------------------------------------------

### National Fish Hatcheries by state <span style="font-size:small">(hover over states for info)</span>

```{r map2, echo=FALSE}
state_data$hover <- with(state_data, paste0(
  "<span style='font-size:larger;font-weight:bold'>", state, 
  ": $", pub_cost, "</span><br>", 
  "<b>Total amount spent per acre of refuge land: $</b> ", dollar_acre
))

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
  
renderPlotly({
  plot_geo(state_data, locationmode = 'USA-states', hoverlabel = "none") %>%
    add_trace(
      z = ~pub_cost, 
      text = ~hover,
      locations = ~state_abb,
      color = ~pub_cost, 
      colors = 'YlOrRd'
    ) %>%
    colorbar(title = "Amount Spent") %>%
    layout(geo = g)
})
```




Wilderness Areas
=======================================================================

Column {data-width=300, .tabset}
-----------------------------------------------------------------------

### Introduction

This table identifies the designated wilderness areas within National Wildlife Refuges. The refuges are also included under the refuge system tab. Includes count of Wilderness Area labeled "state" in bold. This information uses data from Table 8.


### Overall U.S. Numbers

<div style='padding:3px; margin-bottom: 12px; background-color:#FF8400; color:white; border-radius:2px; font-size: 1.2em'>
Total wilderness area
```{r pct_overall3}
tags$p(
  style = "font-size:2em; font-weight:600; color:white",
  sum(wa$wilderness_acres), "acres"
)
```

</div>
<!-- <br> -->

<div style='padding-left:5px; padding-right:50px;'>
\# Acres Aquired by other agencies (the US Department of Energy, etc.)


<hr>

Total spending FY 2019 

</div>

<br>


Column {data-width=800}
-----------------------------------------------------------------------

### Wilderness Areas in National Wildlife Refuges <span style="font-size:small">(hover over states for info)</span>

```{r map3, echo=FALSE}
wild_state_data$hover <- with(wild_state_data, paste0(
  "<span style='font-size:larger;font-weight:bold'>", state, 
  ": ", wilderness_count, "</span><br>", 
  "<b>Total amount of wilderness acre in refuge land: </b> ", wild_acres
))

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
  
renderPlotly({
  plot_geo(wild_state_data, locationmode = 'USA-states', hoverlabel = "none") %>%
    add_trace(
      z = ~wild_acres, 
      text = ~hover,
      locations = ~state_abb,
      color = ~wild_acres, 
      colors = 'YlOrRd'
    ) %>%
    colorbar(title = "Acre") %>%
    layout(geo = g)
})
```





National Monuments
=======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

### Introduction

Point to Table 10. Visualize with a bar graph sorting monuments from smallest to largest? No map (or may small inset map at most)
Add pie chart of all non-monument areas and then monument areas - show vast majority of refuge acreage are in the national monuments.


### Overall U.S. Numbers

<div style='padding:3px; margin-bottom: 12px; background-color:#FF8400; color:white; border-radius:2px; font-size: 1.2em'>
Total refuge land area
```{r pct_overall4}
tags$p(
  style = "font-size:2em; font-weight:600; color:white",
  sum(state_data$pub_cost), "acres"
)
```
</div>
<!-- <br> -->

<div style='padding-left:5px; padding-right:50px;'>
\# Acres Aquired by other agencies (the US Department of Energy, etc.)
```{r n_intra4}
tags$p(
  style = "font-size:1.7em; font-weight:700;",
  sum(state_data$pub_cost)
)
```

<hr>

Total spending FY 2019 
```{r n_list4}
tags$p(
  style = "font-size:1.7em; font-weight:700;",
  "$", sum(state_data$pub_cost)
)
```
</div>

<br>


Column {data-width=800}
-----------------------------------------------------------------------

### Federal spending on National National Monuments <span style="font-size:small">(hover over states for info)</span>


```{r map4, echo=FALSE}
state_data$hover <- with(state_data, paste0(
  "<span style='font-size:larger;font-weight:bold'>", state, 
  ": $", pub_cost, "</span><br>", 
  "<b>Total amount spent per acre of refuge land: $</b> ", dollar_acre
))

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
  
renderPlotly({
  plot_geo(state_data, locationmode = 'USA-states', hoverlabel = "none") %>%
    add_trace(
      z = ~pub_cost, 
      text = ~hover,
      locations = ~state_abb,
      color = ~pub_cost, 
      colors = 'YlOrRd'
    ) %>%
    colorbar(title = "Amount Spent") %>%
    layout(geo = g)
})
```

Column {data-width=800}
-----------------------------------------------------------------------

### Monument acreage size <span style="font-size:small">(smallest to largest)</span>



```{r bargraph, echo = FALSE}


```




### Non-monument areas to monument areas




Data and Background (or More...)
=======================================================================

Column {data-width=1000}
-----------------------------------------------------------------------

### Data
NWRS_refined table in OSF... but keep separate RDS files to pull data for app
```{r data_table, echo = FALSE}
#show <- distinct(intra_occ, scientific, state, .keep_all = TRUE)
#grp <- data_frame(
#  scientific = dat$scientific,
#  taxon = dat$taxon
#) %>% distinct()

#show <- left_join(show, grp, by = "scientific")
#show <- with(show, tibble(
#  state = state, 
#  common = common, 
#  scientific = scientific, 
#  taxon = taxon.x #,
  # URL = paste0("<a target='_blank' href='", scientific_name_url, "'>ECOS Link</a>")
#))

#tags$div(
#  style = "padding:20px; background-color:white;",
#  DT::renderDataTable({
#    DT::datatable(
#      show,
#      filter = "top",
#      escape = FALSE,
#      extensions = c("Buttons"),
#      options = list(
#        rownames = FALSE,
#        paging = FALSE,
#        dom = 'Bfrtip',
#        buttons = c('copy', 'csv', 'excel'),
#        scrollX = TRUE,
#        scrollY = TRUE
#      )
#    )
#  })
#)
```
Column {data-width=1000}
-----------------------------------------------------------------------

### Background

National Wildlife Refuges (NWRs) include the Refuge System lands, waters, and interests administered by Fish and Wildlife Service as wildlife refuges, wildlife ranges, wildlife monument areas, game preserves, and conservation areas. 

National Fish Hatcheries are National Fish Hatchcery System lands and waters where fish are raised. 

Wilderness Areas in National Wildlife Refuges identifies the Congressionally designated wilderness areas within national wildlife refuges and one national fish hatchery. These are also included in the NWR map. 

Discuss breakdown of refuge land: refuges, hatcheries, wilderness areas, national monuments

[TEXT PULLED FROM STORYMAP] As the first nation to develop a formal network of protected areas, the US has led the way in sharing the landscape with our wildlife neighbors. Today, our National Wildlife Refuge System includes some 568 national wildlife refuges, dedicating 95 million acres of land and 760 million acres of submerged lands and waters as a sanctuary for our nation's wildlife. Every state and US territory has at least one wildlife refuge, and most major US cities are within an hour's drive of one.

While their awe-inspiring beauty attracts many human visitors, wildlife comes first on our refuges. The mission of the refuge system goes hand in hand with the goals of the Endangered Species Act (ESA) - the most effective law in the world for saving imperiled species and the ecosystems on which they depend. We have known about the special relationship between the ESA and refuges for decades, but unfortunately there has been no robust tally of how many threatened and endangered species are found on the National Wildlife Refuge System. Defenders of Wildlife and the National Wildlife Refuge Association teamed up to figure it out.

What we found is astounding: 513 ESA-listed species are found or are dependent on at least 444 refuges